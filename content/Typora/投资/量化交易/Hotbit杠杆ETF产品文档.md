# hotbit杠杆ETF产品文档

## 产品逻辑



#### 杠杆etf是什么？

杠杆etf是一种类似杠杆合约的产品，它能够锚定一种数字货币，根据这种锚定货币的涨跌幅，扩大相应倍数的涨跌幅。

与杠杆合约不同的是，杠杆etf会通重平衡（重平衡的具体解释参考下文），使杠杆倍数维持在一定倍数，所以在单边行情内可以获得更大收益，但是在震荡行情里，会遭受损失。

hotbit的杠杆etf的命名规则如下：

BTC1D3L ， 1D(1day)代表1天重平衡一次，3L(3x long) 代表三倍做多 ， BTC代表锚定货币。

BTC1D3S ,  3S(3x short) 代表三倍做空。



#### 杠杆etf的运作实例

BTC1D3L日内价格 =  （1 +（BTC现在价格/BTC锚定价格 - 1） * 3） * BTC1D3L锚定价格

BTC1D3S日内价格 =  （1 -（BTC现在价格/BTC锚定价格 - 1） * 3） * BTC1D3S锚定价格



日间价格更新例子：



第一天：

BTC锚定价格：10000     

BTC1D3L锚定价格： 1   

BTC1D3S锚定价格 ： 1



第二天：

BTC锚定价格：11000

BTC1D3L锚定价格 ： 1.3 （BTC涨了10%，BTC1D3L三倍杠杆涨30%）

BTC1D3S锚定价格 ： 0.7 （BTC涨了10%，BTC1D3S三倍杠杆跌30%）



第三天：

BTC锚定价格：9900

BTC1D3L锚定价格：0.91 （BTC跌了10% ， BTC1D3L三倍杠杆跌30%）

BTC1D3S锚定价格：0.91 （BTC跌了10% ， BTC1D3S三倍杠杆涨30%）



第三天

BTC锚定价格：8910

BTC1D3L锚定价格：0.637 （BTC跌了10% ， BTC1D3L三倍杠杆跌30%）

BTC1D3S锚定价格：1.183 （BTC跌了10% ， BTC1D3S三倍杠杆涨30%）



#### 杠杆etf的重平衡是什么意思？



重平衡是杠杆etf的重要概念。

上面的例子，给出了日内价格更新规则，可以看到日内价格决定于几个锚定价格。

重平衡的第一个功能，就是确定这几个锚定价格。

每天十点半，会根据当时的BTC , BTC1D3L , BTC1D3S 价格 ，作为当天的锚定价格。

重平衡的第二个功能，就是调整对冲仓位。如何调整对冲仓位，在下面的问题会有回答。



#### 什么是对冲？我们怎么对冲客户的仓位？



假设客户以1块钱的价格买了10000个BTC1D3L , 假设BTC涨了10% ， BTC1D3L就会涨30% ， 客户就赚了3000块钱。

假设我们没有在其他的地方对冲这笔订单，客户赚了3000刀，我们就亏了3000刀。

为了避免这种风险，我们可以在客户买入BTC1D3L时，在其他地方做多BTC (客户买入10000块BTC1D3L ， 我们就在okex开30000块钱的多头仓位)。 这样，即使客户赚了3000刀 ， 我们在hotbit亏了3000刀， 但是我们在okex赚了3000刀，不亏不赚，成功消除了客户买入代币后价格波动的风险。



那么重平衡为什么要调整对冲仓位呢？

因为每次重平衡，我们都会调整几个锚定价格，并把okex的仓位调整为hotbit仓位的3倍。

日内的涨跌，会使杠杆倍数偏离3倍，试看下面的例子：

客户以1块钱的价格买了10000个BTC1D3L , BTC涨了10% ， BTC1D3L就会涨30% ，变成1.3一个。

这时，hotbit的仓位为13000USDT  (客户裸多13000USDT)

在客户买入时，我们在okex开了30000刀的多头仓位，BTC涨了10% ， 多头仓位的净值变为33000刀。

此时的杠杆不再是3倍，而是 33000/13000 = 2.54倍

所以我们需要将仓位重新调整为3倍 ， 在okex加6000刀的多头仓位。



上面是客户赚钱的例子，如果客户判断错了方向呢？

客户以1块钱的价格买了10000个BTC1D3L , BTC跌了10% ， BTC1D3L就会跌30% ，变成0.7一个。

这时，hotbit的仓位为7000USDT  

在客户买入时，我们在okex开了30000刀的多头仓位，BTC跌了10% ， 多头仓位的净值变为27000刀。

此时的杠杆不再是3倍，而是 27000/7000 = 3.86倍

所以我们需要将仓位重新调整为3倍 ， 在okex减6000刀的多头仓位。



从上面两个例子我们可以看出，真实的杠杆（即okex仓位/hotbit仓位）并不是一直是3倍，当客户判断对方向时，杠杆倍数会降低，而客户判断错方向时，杠杆倍数会升高。

当杠杆倍数太高时，多出来的仓位不仅毫无意义，还会增加一些爆仓风险。所以每当杠杆倍数大于4倍时，都会触发以此日内的重平衡，调整仓位，并更新锚定价格。



## 代码细节



### hotbit_rest.py

这个文件封装了hotbit的rest接口，我们用这个文件里的接口来查询账户，撤单下单，查询订单信息。

### ok_rest.py

这个文件封装了okex的rest接口，我们用这个文件里的接口来查询账户，撤单下单，查询订单信息。

### ok_ws.py

这个文件封装了okex的websocket接口，我们主要用websocket接口推送价格信息。



### 主函数main_final.py



####  OkefSmartMv okex对冲模块

对冲模块有两个重要协程。

一个协程是update_info_loop , 顾名思义，这个协程是为了更新okex usdt永续期货端的的信息，每隔1秒钟，它会去okex拿期货对应的数据（包括净值，多空仓位等数据），然后更新。

另外一个协程是place_loop, 这个是下单的协程。下单怎么下，我们采用的方式是设置一个目标仓位，如果现在的仓位（做多仓位-做空仓位）和目标仓位不一样，我们就会通过开多或者开空的方式把仓位变成和目标仓位一致。

至于这个目标仓位如何设置，在后面的重平衡模块和hotbit主函数模块里会介绍。





#### Rebalance 重平衡模块

重平衡有两个部分。

一部分是在杠杆过大(超过4倍）的情况下重平衡，程序会先检查杠杆过大是否是一个持续事件（在对冲时可能出现短暂大杠杆，但此后会恢复），如果30秒内杠杆均过大，程序会发动重平衡，把okex的仓位调整为hotbit仓位的三倍（调整对冲模块的目标仓位），并更新指数价格。

另一部分是每天早上10点半重平衡。第一，bear和bull的价格都乘以0.998（收用户的管理费）。第二，把okex的仓位调整为hotbit仓位的三倍，并更新指数价格。



####  Hotbit主函数模块 main

主函数模块负责在hotbit挂单。

首先计算指数价格。

bull指数价格 = （1 +（现在价格/指数价格 -1）* 3） * 指数bull价格

bear指数价格 =（1 -（现在价格/指数价格 -1）* 3） * 指数bear价格

然后根据指数价格挂单，挂20张bid和20张ask单。

下单以后，监听每张订单，如果有成交，就在okex做相应的对冲。

例如1块钱卖出去100个bull , 相当于客户买到100块钱的bull , 应该开300块钱的多头仓位，于是就在okex开相应张数的多头仓位（okex的一张是0.01个btc,如果客户下单量较小，可能不完全是3倍）





## 操作说明



- Q: 如何开启BTC的ETF做市？
- A: cd 到主文件夹，用 sh auto_hotbit.sh 指令开启做市。
- Q: 如何开启ETH的ETF做市？
- A: cd 到主文件夹，用 sh auto_hotbit_eth.sh 指令开启做市。
- Q: 如果要开启其他交易对，如何操作？
- A: 复制一份 main_final_eth.py 代码 ， 改Config里的参数（包括代币名称，apikey , secretkey , okex相关key信息等），然后构造相似的sh文件(比如要上bch , 可以auto_hotbit_bch.sh文件）
- Q: 怎样停止ETF做市？
- A: 持续按ctrl+c ， 直到程序停止。
- Q: 如果接到电话警报，如何操作？
- A: 先停止ETF做市，然后进入OKEX账户，降低仓位。（我们在还有20%爆仓时就会预警。现在的设置是50000bull , 50000bear ,okex 10w usdt，所以理论上最大杠杆在1.5倍左右，爆仓风险较小）
- Q: 如何建立后台？
- A: 在服务器里安装influxdb（时间序列数据库）和grafana（监控平台） , 然后改变代码里的相应参数，即可输出数据到自己服务器的influxdb数据库上。具体参考influxdb和grafana的文档。
- Q: 遇到问题如何查看日志？
- A: 文件夹下的home文件夹内记录了策略日志，所有打印的信息保存在日志里，可以根据日志debug 。











