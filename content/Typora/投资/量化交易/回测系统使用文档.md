# 回测系统使用文档



## 示例策略1-简易现货做市策略



### 策略简介

做市策略，简单来说，就是在市场两侧挂单，为市场提供流动性的策略。现设计一个有如下特性的做市策略

- 买单与卖单的距离近，容易与对手方成交
- 根据持仓量决定挂单位置，当币多时倾向于卖，币少时倾向于买



![img](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ly863sryj30k00ap74y.jpg)

当多头风险变大(币太多）时，随着风险持续增大，先把bid挂远 （不倾向与买） ， 再把ask挂近 （倾向于卖）

当空头风险变大(币太少）时，随着风险持续增大，先把ask挂远（不倾向于卖） ， 再把bid挂近  （倾向于买）



### 参数设计

什么是近？ 与对手最优价格贴近 ， 例如最近的买单就是 best_ask - min_change , 卖单是 best_bid + min_change

什么是远？ 离最近价格 $2*(maker+taker)*price$的位置



### 策略源码

```python
import copy

class MarketMaker(object):
    #----------------------------------------------------------------------
    def __init__(self, exchange):
        """Constructor"""
        self.exchange = exchange
        self.symbol = self.exchange.symbol
        self.coin_a , self.coin_b = self.symbol.split("-")
        
        self.account = None
        self.depth = None

        self.history_time = []
        self.history_pnl = []

    def main(self):
        
        # cancel orders
        orders = self.exchange.get_orders()
        for o in orders:
            self.exchange.cancel_order(o)
        
        
        # get depth and account
        
        self.account = self.exchange.get_account()
        self.depth = self.exchange.get_depth()
        ask = self.depth.asks[0]
        bid = self.depth.bids[0]
        makerfee = bid * (-1/10000)
        takerfee = bid * (3/10000)
        min_change = 0.001
        
        self.balance = (self.account[self.coin_a] * bid + self.account[self.coin_b])
        coin_a_rate = (self.account[self.coin_a] * bid) / self.balance
        self.history_pnl.append(self.balance)
        assert coin_a_rate>=0 and coin_a_rate<=1
        
        # compute new buy price and sell price
        
        fee_unit = makerfee+takerfee
        if coin_a_rate < 0.25:
            #买！
            sell_price = bid + min_change + 2*fee_unit
            x = (coin_a_rate - 0)*4 + 0
            buy_price = ask - min_change - x*fee_unit
        elif coin_a_rate >= 0.25 and coin_a_rate < 0.5:
            #不卖！
            buy_price = ask - min_change - fee_unit
            x = (coin_a_rate-0.25)*(-4) + 2
            sell_price = bid + min_change + x*fee_unit
        elif coin_a_rate >=0.5 and coin_a_rate < 0.75:
            #不买！
            sell_price = bid + min_change + fee_unit
            x = (coin_a_rate-0.5)*4 + 1
            buy_price = ask - min_change - x*fee_unit
        else:
            #卖
            buy_price = ask - min_change - 2*fee_unit
            x = (coin_a_rate - 0.75)*(-4) + 1
            sell_price = bid + min_change + x*fee_unit
            
        # send order
        vol = self.balance * 0.05
        buy_vol = round(vol/buy_price , 2)
        buy_price = round(buy_price , 3)
        sell_vol = round(vol/sell_price , 2)
        sell_price = round(sell_price , 3)
        
        
        if self.account[self.coin_b] >= buy_price * buy_vol:
            self.exchange.buy(buy_price , buy_vol)
        if self.account[self.coin_a] >= sell_vol:
            self.exchange.sell(sell_price , sell_vol)
        
        
        self.exchange.sleep(0.5)
        
```













## 数据结构



### 行情信息



部分函数会附带在调用时请求返回的原始JSON信息，该原始JSON数据储存在返回对象的**Info**属性中，以下是各个数据结构的主要属性描述。

##### Trade

获取所有交易历史(非自己),由`exchange.GetTrades()`函数返回。

```javascript
{
    Time    : 1567736576000, // 时间(Unix timestamp 毫秒)
    Price   : 1000,          // 价格
    Amount  : 1,             // 数量
    Type    : 0              // 订单类型,参考常量里的订单类型,0即为ORDER_TYPE_BUY，ORDER_TYPE_BUY的值为0
}
```

##### Ticker

市场行情由`exchange.GetTicker()`函数返回。

```javascript
{
    Info    : {...},         // rest Request 请求交易所接口后，交易所接口应答的原始数据。
    High    : 1000,          // 最高价
    Low     : 500,           // 最低价
    Sell    : 900,           // 卖一价
    Buy     : 899,           // 买一价
    Last    : 900,           // 最后成交价
    Volume  : 10000000,      // 最近成交量
    Time    : 1567736576000  // 毫秒级别时间戳
}
```

##### Record

标准OHLC结构,用来画K线和指标分析用的，由`exchange.GetRecords()`函数返回此结构数组。

```
{
    Time    : 1567736576000,    // 一个时间戳,精确到毫秒，与Javascript的new Date().getTime()得到的结果格式一样
    Open    : 1000,             // 开盘价
    High    : 1500,             // 最高价
    Low     : 900,              // 最低价
    Close   : 1200,             // 收盘价
    Volume  : 1000000           // 交易量
}
```

##### Order

订单结构，由`exchange.GetOrder()`，`exchange.GetOrders()`函数返回。

```
{
    Info        : {...},            // rest Request 请求交易所接口后，交易所接口应答的原始数据
    Id          : 123456,           // 交易单唯一标识
    Price       : 1000,             // 下单价格
    Amount      : 10,               // 下单数量
    DealAmount  : 10,               // 成交数量
    AvgPrice    : 1000,             // 成交均价，注意，有些交易所不提供该数据，不提供的设置为0
    Status      : 1,                // 订单状态,参考常量里的订单状态ORDER_STATE_CLOSED
    Type        : 0,                // 订单类型,参考常量里的订单类型ORDER_TYPE_BUY
    Offset      : 0                 // 数字货币期货和商品期货的订单数据中，订单的开平仓方向，ORDER_OFFSET_OPEN为开仓，ORDER_OFFSET_CLOSE为平仓方向
}
```

##### Depth

市场深度,由`exchange.GetDepth()`函数返回。

```
{
    Asks    : [...],          // 卖单数组,MarketOrder数组,按价格从低向高排序
    Bids    : [...],          // 买单数组,MarketOrder数组,按价格从高向低排序
    Time    : 1567736576000   // 毫秒级别时间戳
}
```

##### Account

账户信息，由`exchange.GetAccount()`函数返回。

```
{
    Info            : {...},  // rest Request 请求交易所接口后，交易所接口应答的原始数据。
    Balance         : 1000,   // 余额(人民币或者美元,在Poloniex交易所里ETC_BTC这样的品种,Balance就指的是BTC的数量,Stocks指的是ETC数量)
    FrozenBalance   : 0,      // 冻结的余额
    Stocks          : 1,      // BTC/LTC数量,数字货币现货为当前可操作币的余额(去掉冻结的币),数字货币期货的话为合约当前可用保证金(传统期货无此属性)
    FrozenStocks    : 0       // 冻结的BTC/LTC数量(传统期货无此属性)
}
```

##### Position

期货交易中的持有仓位信息，由`exchange.GetPosition()`函数返回此结构数组。

```
{
    Info            : {...},      // rest Request 请求交易所接口后，交易所接口应答的原始数据
    MarginLevel     : 10,         // 杆杠大小
    Amount          : 100,        // 持仓量，OKEX合约交易所，表示合约的份数(整数且大于1，即合约张数)
    CanCover        : 100,        // 可平量,只有股票有此选项,表示可以平仓的数量(股票为T+1)今日仓不能平
    FrozenAmount    : 0,          // 仓位冻结量
    Price           : 10000,      // 持仓均价
    Profit          : 0,          // 持仓浮动盈亏(数据货币单位：BTC/LTC,传统期货单位:RMB,股票不支持此字段,注:OKEX合约全仓情况下指实现盈余,并非持仓盈亏,逐仓下指持仓盈亏)
    Type            : 0,          // PD_LONG为多头仓位(CTP中用closebuy_today平仓),PD_SHORT为空头仓位(CTP用closesell_today)平仓,(CTP期货中)PD_LONG_YD为咋日多头仓位(用closebuy平),PD_SHORT_YD为咋日空头仓位(用closesell平)
    ContractType    : "quarter",  // 商品期货为合约代码,股票为'交易所代码_股票代码',具体参数SetContractType的传入类型
    Margin          : 1           // 仓位占用的保证金
}
```