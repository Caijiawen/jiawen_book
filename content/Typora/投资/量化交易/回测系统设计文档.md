# 回测系统设计文档

#### 时间旅行 sleep 函数



sleep(duration = none)

duration：睡眠时间



当用户在策略中选择睡眠n秒时，交易所要做的有两件事：

- 更新行情数据

- 撮合订单并更新账户数据

而在回测系统中 ， 我们

- 根据新时间选择新数据，假设策略时间是01:00:01  , 而历史数据里在策略时间之前最新的数据时间是 01:00:00.765 ， 那么这个时候的数据便是 01:00:00.765 对应的历史数据（给个例子。。。）
- 假设在sleep的过程，时间从 01:00:00 来到了 01:00:01 ， 那么在其中的所有数据



#### 撮合引擎 cross_order 函数



交易所是如何撮合的？

交易所可以看作一个状态机

一个时刻 t 对应一个状态 $s_t$ :  [[bid1,bid1_vol],[bid2,bid2_vol],....]  [[ask1,ask1_vol],[ask2,ask2_vol],....]

任何一个新订单进入以后，状态机变为 $s_{t+1}$







#### 网络延迟模拟

假设数据从服务器发射到交易所需要 a 秒 ， 交易所发射到服务器需要 b 秒。

那么 get_depth 等等函数，拿到的是 b 秒以前的数据  （拿到的是 t-b 之前的数据）

而 buy , sell 等函数 ， 要等 a 秒才能到达交易所 （要在 t+a 以后才开始撮合）





#### 期货盈亏计算

OKEX比特币虚拟合约的杠杆表现为法币收益层面的杠杆稳定：投入100美元，所能得到的收益=100美元*比特币的涨跌幅*固定的杠杆倍数。

假设当前价格为500USD/BTC，某投资者以当前价格买入一个BTC，本金为500USD,此时投资者可以做多50张BTC虚拟合约。此时若BTC价格上涨至750美元，涨幅50%，投资者合约收益为3.3333个BTC，按照当前价格卖出后可以获得2500美元，收益为其本金投入的5倍。若价格上涨至1000美元，合约收益为5BTC，卖出后的美元收入为5000美元，为其美元收入的10倍。无论价格怎么波动，合约的杠杆都十分稳定，从而方便商家用合约进行套保，也便于普通投资者管理其仓位。

![image-20191206221150126](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ncyfzsckj314g06gmyl.jpg)

用 position 储存多仓和空仓的张数。

收益率 = (现在的指数价格 - 开仓均价) / 开仓均价 

收益额 = 张数\*每张面值\*收益率

