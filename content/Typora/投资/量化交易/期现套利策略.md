# 期现套利策略
## 基本的盈利逻辑



所有的期货现货套利策略，可以看成一个简单的数学问题：

​                                                        

​                                                         $$ f(diff) = pos $$



公式里的diff代表的是期货和现货的价差 ， pos代表的是期货的净仓位。假设我们希望在价差收敛的过程中盈利，那么当diff是正的时候，我们的期货仓位会偏空仓；而diff是负的时候，我们的期货仓位会偏多仓。

![WechatIMG4](http://ww2.sinaimg.cn/large/006tNc79gy1g5z0ipoc5uj30u01400um.jpg)

在我们的策略中，我们假设这个函数是一个线性函数。我们用一个图来表示这个函数。这个图上的变量含义如下：

- `max` , `min`   最大价差和最小价差

- `max_pos` , `min_pos`   最大价差对应的仓位和最小仓位对应的仓位
- `cur` 现在的价差
- `cur_pos`  现在的价差所对应的仓位
- `real_pos` 现在的真实仓位



我们的目标很简单，就是让 `real_pos` 尽可能地接近  `cur_pos`。那么如何下单来达成目标呢？



我们的做法是用 `real_pos` 映射到直线上获取 `calc_diff`   , 然后以 `calc_diff` 作为差价来进行交易。



​                                     $$spot\_order\_price = future\_price - calc\_diff$$



在这样的情形下 ：

当`real_pos` 等于 `cur_pos`   ， 差价正好是 `cur` ， 这是平衡状态。

当`real_pos` 小于 `cur_pos` 时 ， `calc_diff` 大于 `cur`  ，现货倾向卖 ， 期货倾向买 ， `real_pos`会增加

当`real_pos` 大于 `cur_pos` 时 ， `calc_diff` 小于 `cur`  ，现货倾向买 ， 期货倾向卖 ， `real_pos`会减少



所以无论如何，我们的挂单都会使 `real_pos` 尽可能地接近  `cur_pos`  。



### 利润的数学计算

在我们的假设中 ， f(diff) = pos 是一个线性的函数。线性意味着简单，当差价是 n 的时候 ， 仓位就是 a*n 。这代表我们的网格是均匀的，从 max 到 0 可以获取的利润是

$$ \int_{0}^{max}ax dx =  0.5a* max^2 $$   

如果在max一把梭哈 a*max , 赚的是 $a * max^2$   , 网格法的利润是梭哈法的一半。

但是梭哈法只有一次机会，但当我们使用网格法时，只要在区间内来回移动，我们就在不停歇地盈利。

值得注意的是 ， 在边界来回移动赚得最多 （从max到0.5max产生的盈利是梭哈法的3/4）：

$$ \int_{0.5max}^{max}axdx = 0.375a * max^2 $$

所以我们要尽量让差价在边界附近来回震荡。

### 推广：其他问题

当我们想实现   $$ f(a) = b $$ 时，有的时候可以用逆向思维， 考虑用 $$f^{-1}(b) = a$$ 的方式达成目标。

在金融中 ， 通常有一个变量是仓位的大小。

例如，如果我们要做市，f(仓位) = 挂单距离 。

仓位多头越多， 多头挂单距离越远，空头挂单距离越近，这会使仓位恢复均衡状态。 



## 对冲基础

法币恒定策略： 

维持usdt不变 ， 现货btc头寸通过期货btc空头进行对冲 

加密货币恒定策略： 
维持btc不变 ， 现货usdt头寸通过期货btc多头（相当于做空usdt）进行对冲 

## 线性函数
[image:BF3190EF-CE9D-48F1-AA3A-9B5593CC6D49-3926-00010642770EC329/7CB65498-EB72-46E6-84BA-6C559036CE9C.png]

x轴 ： 价差  min 到 max
Y轴： 仓位   min_pos 到 max_pos
作用原理  

根据现在的cur_pos 算  position (up,down跟position差不多，可以理解为place order diff , 现货按照 future - position来下单)

根据position来下单的话，如果position小于diff很多的话，买卖单就会在ask上面，那么现货端会买入，那么cur_pos会增大，导致position也变大趋近于diff。同理，如果大于diff很多，买卖单在bid下面，现货端卖出，cur_pos卖出，position变小趋近于diff。这个说的是*diff和cur_pos的对应锁定关系*。

## 宏观盈利逻辑
给定一个diff , 我们会通过调仓调到对应的cur_pos , 这个有什么用呢？

一般的期现套利，就是在贴水的时候买入期货卖出现货，升水得时候卖出期货买入现货。

我们可以搞一个线性函数，贴水贴得越凶，买期货买得越凶，升水升得越凶，卖期货卖得越凶。

diff越小，cur_pos越小，期货越倾向于做多。
diff越大，cur_pos越大，期货越倾向于做空。

## 微观盈利逻辑
现货端智能做市策略在bid , ask 两端挂单 ，如果能够成交 ，则在期货端对冲掉持仓风险。

现货future_bid - self.up  期货 future_bid 
现货future_ask - self.down 期货 future_ask

那么买现货卖期货 self.up
卖现货买期货 self.down
如果各成交一次 赚self.up - self.down

这一过程中赚到现货端抖动的利润 （以低价买入，高价卖出）。

利润的大小与标的的波动性正相关。

## 策略细节

### Asyncio 异步机制

* asyncio是一个协程（concurrent) ，一个线程内智能分配调用顺序 
* async 函数返回的是 coroutine object , 必须用 await 把操作的结果弄出来
* 类似多线程的方式之一： 把要做的事写到create_task(和ensure_future作用类似)里（其实在这里就开干了，统一将他们命名为开干函数），最后再分别await得到结果,另一种方式是使用gather函数

### 策略框架

同时运行以下模块

* 主函数
* 对冲函数


*main函数*

检查tick(async异步，获取tick在另一个线程运行) 

计算cur_pos (现在仓位，如果法币以法币算，币本位以币计算） 
cur_pos = now - max_pos 

max_pos(现货仓位的一半)    min_pos(max_pos的相反数) 

所以cur_pos为max_pos时倾向卖  （position大） 
cur_pos为min_pos时倾向买 （position小） 

bid_price = bid - position - earn/2 
ask_price = ask - position + earn/2 

*watch order update函数*

每隔interval弄一次 

监听订单，一旦有成交便log信息，产看每次成交的数量 
一直保持 
dealt_amount 和 dealt_price 的更新(通过getorderinfo获取) 

更新每次成交的平均价格和总的平均价格 

*on trade函数*

每次现货端有成交就在期货端进行对冲 

*Smart Order 智能下单系统*

*cost计算*

buycost = realbuyprice - targetbuyprice 
sellcost = targetsellprice - realsellprice 

allcost = buycost*realbuyamount +sellcost*realsellamount 
cost = allcost/(realbuyamount + realsellamount) 

*buyloop*

检查有无未成交单子，确保撤掉它们 

下单 

下单后用watch_order_update_f 监听这个单子的情况 

*watch_order_update_f*

多个错误处理细节： 
如果 order 没有返回 
如果获取不到order的信息 — on_trade统计真实买入卖出的量 


### grafana可视化后台 

#### balance图 
全部折算为基准币数量 

#### mv图 
净持币数量。假设运行的币种是btc，现货有2个btc，那么spot mv就是2个btc，期货保证金2btc,做空4btc，那么future mv就是-2btc 。为了保证风险被对冲 ， spot mv + future mv 应该在0附近 

#### 成交点位图
正常情况下成交价差应该分别在up和down上 



### 期现实盘



#### 2019三季度











#### 2019四季度



两套策略：

维持offset不变 （7.5%）

递减offset (15%到3%)



![image-20190909161831800](https://tva1.sinaimg.cn/large/006y8mN6gy1g6tc7q7p1qj30d005zt8t.jpg)





#### 文件清单



- auto_example.sh      运行文件，命令行中sh auto_example.sh即可运行
- CONFIG_example.py    参数设置文件，里面有详细注释
- influx_api.py    连接influxdb的文件
- logger.py    日志文件
- utils.py      辅助函数
- ok_api_v3.py   OKEX rest api
- ok_ws_vs.py   OKEX websocket api
- qixian_template_okv3.py   主文件，策略文件（ok现货ok期货）
- huobi_future_rest.py  ， huobi_future_ws.py  huobi期货的rest和websocket api
- huobi_spot_rest_async.py ，huobi_spot_ws_async.py   huobi现货的rest和websocket api
- qixian_template_huobi_okex.py    huobi现货，ok期货策略文件
- CONFIG_huobi_example.py  ，auto_huobi_example.py   huobi现货,ok期货的参数设置文件和运行文件



#### 你们需要做的事情

- 安装influxdb 
- 安装grafana (后台监控)
- 注册onealert (警报)





